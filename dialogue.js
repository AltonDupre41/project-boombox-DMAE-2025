// Group 1: ID 0-12
const dialoguesGroup1 = [
  // Dialogue ID 0
  ["*phone ringing*"],

  // Dialogue ID 1
  ["Hello"],

  // Dialogue ID 2
  ["Boombie!"],

  // Dialogue ID 3
  ["I thought I blocked this number"],

  // Dialogue ID 4
  ["Don't be like that. I hope your song is finished, the concert is tonight."],

  // Dialogue ID 5
  [
    "Of course it's done! I'm one of the greatest musicians in the world! Who do you take me for?!",
  ],

  // Dialogue ID 6
  ["Right. We'll see tonight"],

  // Dialogue ID 7
  ["*click*"],

  // Dialogue ID 8
  ["I haven't even started"],

  // Dialogue ID 9
  [
    "It's been a while since I made a new song. The hardest part is choosing each piece of the sound, because even the smallest change can completely alter the song. What if it turns out that the other sound I didn't pick ends up being the better choice? Awww, I'm getting anxious just thinking about it!",
  ],

  // Dialogue ID 10
  [
    "My first choice, the bassline! Hmm they're both probably really good, how will I choose??",
  ],

  // Dialogue ID 11
  [
    "Bassline 1: This gear hums with restless energy. It buzzes like a neon sign in a sleepless city.",
  ],

  // Dialogue ID 12
  [
    "Bassline 2: This gear pulses like a calm heartbeat. Steady. Simple. Certain.",
  ],
];

// Group 2: ID 13-31
const dialoguesGroup2 = [
  // Dialogue ID 13
  ["Boombie!"],

  // Dialogue ID 14
  ["Old man R.C.! How are you? Did you get that bent needle replaced?"],

  // Dialogue ID 15
  ["Yea yea, you're so funny Boombie. How is the song coming?"],

  // Dialogue ID 16
  ["What do you mean? The concert is today, I finished it weeks ago!"],

  // Dialogue ID 17
  [
    "Don't lie to me, Boombie. I've mentored you for far too long to know that's not the case",
  ],

  // Dialogue ID 18
  ["...I can't decide on the sound, what if I make the wrong choice?"],

  // Dialogue ID 19
  ["What if you don't make a choice at all?"],

  // Dialogue ID 20
  ["...Well I wouldn't have a song at all…"],

  // Dialogue ID 21
  ["If you ask me that would be much worse than either choice"],

  // Dialogue ID 22
  ["I guess so…"],

  // Dialogue ID 23
  [
    "Boombie, it's true that each decision is important. But no matter what choice you make, I know you'll do great. The worst mistake you could make would be not making a decision at all. Take what comes with the decision and keep moving forward. I think you'll make a great decision though",
  ],

  // Dialogue ID 24
  ["…"],

  // Dialogue ID 25
  ["I guess I never thought about it like that."],

  // Dialogue ID 26
  [
    "And that's ok. That's why I'm here. I'll be at the concert tonight, and I expect a great song. Take care, Boombie.",
  ],

  // Dialogue ID 27
  [
    "The chord is next. I'll try and take old man R.C.'s advice, and not think too hard. I've got a great musical ear, I don't know why I'm even overthinking it!",
  ],

  // Dialogue ID 28
  ["Chord 1.1: A delicate gear, light as a feather—floaty and ethereal."],

  // Dialogue ID 29
  [
    "Chord 1.2: This gear is heavy with motion—like factory pistons in perfect chaos.",
  ],

  // Dialogue ID 30
  ["Chord 2.1: This gear hums a long breath—held just a second too long."],

  // Dialogue ID 31
  ["Chord 2.2: This gear speaks in bold steps. No fear. No hesitation."],
];

// Group 3: ID 32-55
const dialoguesGroup3 = [
  // Dialogue ID 32
  [
    "Woah, this is nice! There's more work to be done, but it's really coming together! R.C. was right, better to move forward than stay in the same place out of fear.",
  ],

  // Dialogue ID 33
  ["*Phone ringing*"],

  // Dialogue ID 34
  ["Ughhhhhh"],

  // Dialogue ID 35
  ["Helloooo?"],

  // Dialogue ID 36
  ["Rehearsal started an hour ago, where are you???"],

  // Dialogue ID 37
  ["Uhhh… in traffic"],

  // Dialogue ID 38
  ["You live down the street"],

  // Dialogue ID 39
  ["I needed to hit the bank"],

  // Dialogue ID 40
  ["...It's Sunday"],

  // Dialogue ID 41
  ["..."],

  // Dialogue ID 42
  ["…"],

  // Dialogue ID 43
  [
    "Well if you're not coming to rehearsal can I at least get a snippet of the song. The crew wants to make sure they're in tune for the show",
  ],

  // Dialogue ID 44
  ["Uhh, can't right now, still driving"],

  // Dialogue ID 45
  ["You're literally a Boombox."],

  // Dialogue ID 46
  ["What's that? You're breaking up"],

  // Dialogue ID 47
  ["I know you can hear me!!!"],

  // Dialogue ID 48
  ["I'm in a tunnel, I'll call you back!!!"],

  // Dialogue ID 49
  ["*click*"],

  // Dialogue ID 50
  ["Gosh she's worse than my mother"],

  // Dialogue ID 51
  [
    "The song is coming along nicely, but a melody would take it to the next level!",
  ],

  // Dialogue ID 52
  [
    "Melody 1.1: This gear thrums with boldness—each note walks tall and leaves footprints behind.",
  ],

  // Dialogue ID 53
  [
    "Melody 1.2: This gear chirps and hops like it's playing a game. Playful but precise.",
  ],

  // Dialogue ID 54
  ["Melody 2.1: This gear quivers with tension and a nervous rhythm."],

  // Dialogue ID 55
  [
    "Melody 2.2: This gear is cracked but shining. It sings a harmonic tune of perseverance.",
  ],
];

// Group 4: ID 56-77
const dialoguesGroup4 = [
  // Dialogue ID 56
  [
    "Now we're cooking! A melody is just what I needed, and this might be my best work yet! All it takes is a little bit of determination and now I'm back on top!!!",
  ],

  // Dialogue ID 57
  ["…"],

  // Dialogue ID 58
  [
    "Well, let me not get ahead of myself. I should probably find a way to make it to the concert on time first XD",
  ],

  // Dialogue ID 59
  ["I made it!!! Time to rock this place! #1 hit single here I come!!!"],

  // Dialogue ID 60
  ["Boombie!"],

  // Dialogue ID 61
  ["Hey, it's… you!"],

  // Dialogue ID 62
  ["…"],

  // Dialogue ID 63
  ["…"],

  // Dialogue ID 64
  [
    "I've served as your manager for the last 10 years and you can't even remember my name?",
  ],

  // Dialogue ID 65
  ["Of course I know your name"],

  // Dialogue ID 66
  ["…"],

  // Dialogue ID 67
  ["…"],

  // Dialogue ID 68
  ["So anyways time for my performance ok byeeee :)"],

  // Dialogue ID 69
  ["Well it better be good"],

  // Dialogue ID 70
  [
    "Every choice we make—no matter how small—shapes the melody of our lives. A single decision can send us down a path we never imagined, for better or worse. But the worst thing we can do... is nothing. Because standing still doesn't stop the world from moving—it just leaves us behind.",
  ],

  // Dialogue ID 71
  ["Great work kid, I knew you'd pull through!"],

  // Dialogue ID 72
  [
    "Thank you sir, I couldn't have done it without you! It's crazy how such seemingly small decisions can have such a major impact in the grand scheme of things!",
  ],

  // Dialogue ID 73
  ["You never cease to amaze me on all fronts"],

  // Dialogue ID 74
  ["Aside from composing, it's my specialty :D"],

  // Dialogue ID 75
  [
    "Yeah no kidding. Everyone's super hyped for your upcoming world tour, and if the rest of the new album is anything like this, you'll knock it out of the park!",
  ],

  // Dialogue ID 76
  ["…"],

  // Dialogue ID 77
  ["What"],
];

// Combine all groups into a single array for backward compatibility
const dialogues = [
  ...dialoguesGroup1,
  ...dialoguesGroup2,
  ...dialoguesGroup3,
  ...dialoguesGroup4,
];

// Define group ranges for easy lookup
const dialogueGroups = [
  { name: "Group 1", start: 0, end: 12, dialogues: dialoguesGroup1 },
  { name: "Group 2", start: 13, end: 31, dialogues: dialoguesGroup2 },
  { name: "Group 3", start: 32, end: 55, dialogues: dialoguesGroup3 },
  { name: "Group 4", start: 56, end: 77, dialogues: dialoguesGroup4 },
];

// Track the current dialogue IDs being displayed
let displayedDialogueIds = [];
let currentGroupIndex = 0;

/**
 * Find which group a dialogue ID belongs to
 * @param {number} dialogueId - The ID to find
 * @returns {number} The index of the group, or -1 if not found
 */
function findDialogueGroup(dialogueId) {
  for (let i = 0; i < dialogueGroups.length; i++) {
    const group = dialogueGroups[i];
    if (dialogueId >= group.start && dialogueId <= group.end) {
      return i;
    }
  }
  return -1;
}

/**
 * Get the next dialogue ID in the current group
 * @param {number} currentId - The current dialogue ID
 * @param {number} groupIndex - The group index
 * @returns {number} The next dialogue ID
 */
function getNextDialogueId(currentId, groupIndex) {
  const group = dialogueGroups[groupIndex];
  const localIndex = currentId - group.start;
  const nextLocalIndex = (localIndex + 1) % group.dialogues.length;
  return group.start + nextLocalIndex;
}

/**
 * Advance the dialogue by removing the first one and adding a new one
 */
function advanceDialogue() {
  // Remove the first dialogue ID
  const removedId = displayedDialogueIds.shift();

  // Get the ID that comes after the last currently displayed ID
  const lastId = displayedDialogueIds[displayedDialogueIds.length - 1];
  const nextId = getNextDialogueId(lastId, currentGroupIndex);

  // Add the new ID to the end
  displayedDialogueIds.push(nextId);

  // Update the display
  updateDialogueDisplay();

  console.log(`Advanced dialogue: removed ID ${removedId}, added ID ${nextId}`);
}

/**
 * Display dialogue in the chat box
 * @param {number} dialogueId - The ID of the dialogue to display
 */
function triggerDialogue(dialogueId) {
  console.log(`triggerDialogue called with ID: ${dialogueId}`);

  // Convert dialogueId to number if it's a string
  dialogueId = parseInt(dialogueId, 10);

  // Find which group this dialogue belongs to
  const groupIndex = findDialogueGroup(dialogueId);
  if (groupIndex === -1) {
    console.error(`Dialogue ID ${dialogueId} not found in any group`);
    return;
  }

  // Update current group
  currentGroupIndex = groupIndex;

  // Initialize displayed dialogues with the current ID
  displayedDialogueIds = [dialogueId];

  // Add the next two dialogue IDs
  let nextId = getNextDialogueId(dialogueId, currentGroupIndex);
  displayedDialogueIds.push(nextId);

  nextId = getNextDialogueId(nextId, currentGroupIndex);
  displayedDialogueIds.push(nextId);

  // Display the dialogues
  updateDialogueDisplay();

  console.log(
    `Displayed dialogue IDs: ${displayedDialogueIds.join(", ")} from ${
      dialogueGroups[currentGroupIndex].name
    }`
  );
}

/**
 * Update the dialogue display with the current displayedDialogueIds
 */
function updateDialogueDisplay() {
  // Get or create chat container
  let chatContainer = document.querySelector(".chat-container");
  if (!chatContainer) {
    chatContainer = document.createElement("div");
    chatContainer.className = "chat-container";
    document.body.appendChild(chatContainer);
    console.log("Created chat-container");
  }

  // Get or create chat messages area
  let chatMessagesElement = document.querySelector(".chat-messages");
  if (!chatMessagesElement) {
    chatMessagesElement = document.createElement("div");
    chatMessagesElement.className = "chat-messages";
    chatContainer.appendChild(chatMessagesElement);
    console.log("Created chat-messages element");
  }

  // Clear previous messages
  chatMessagesElement.innerHTML = "";

  // Display each dialogue
  displayedDialogueIds.forEach((id) => {
    const dialogue = dialogues[id];
    if (!dialogue) {
      console.error(`Dialogue ID ${id} not found in dialogues array`);
      return;
    }

    // Create a container for this dialogue
    const dialogueContainer = document.createElement("div");
    dialogueContainer.className = "dialogue-container";
    dialogueContainer.dataset.dialogueId = id;

    // Add each message in the dialogue
    dialogue.forEach((messageText) => {
      const messageElement = document.createElement("div");
      messageElement.textContent = messageText;
      messageElement.className = "message";
      dialogueContainer.appendChild(messageElement);
    });

    chatMessagesElement.appendChild(dialogueContainer);
  });

  // Scroll to the bottom of the chat
  chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;

  // Create or update the next button
  let nextButton = document.querySelector(".next-button");
  if (!nextButton) {
    nextButton = document.createElement("button");
    nextButton.className = "next-button";
    nextButton.textContent = "Next";
    nextButton.style.padding = "8px 16px";
    nextButton.style.margin = "10px";
    nextButton.style.backgroundColor = "#4CAF50";
    nextButton.style.color = "white";
    nextButton.style.border = "none";
    nextButton.style.borderRadius = "4px";
    nextButton.style.cursor = "pointer";

    // Add the button to the container
    chatContainer.appendChild(nextButton);
  }

  // Add event listener to the next button
  nextButton.onclick = function () {
    advanceDialogue();
  };
}

// Add some basic styles for the chat interface
function addChatStyles() {
  const style = document.createElement("style");
  style.textContent = `
    .chat-container {
      max-width: 500px;
      margin: 20px auto;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .chat-messages {
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .dialogue-container {
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      background-color:rgb(100, 100, 100);
      border-radius: 15px;
      max-width: 95%;
      word-wrap: break-word;
    }
    .next-button:hover {
      background-color: #45a049;
    }
  `;
  document.head.appendChild(style);
}

// Initialize styles when the script loads
addChatStyles();

// Make sure triggerDialogue is explicitly in the global scope
window.triggerDialogue = triggerDialogue;

console.log(
  "dialogue.js loaded, triggerDialogue function is available in global scope:",
  typeof window.triggerDialogue === "function"
);
